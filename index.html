<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Folder</title>
<link rel="icon" href="icon.png" type="image/png">
<style>
body { font-family: Arial,sans-serif; margin:0; padding:20px; max-width:1200px; margin:auto; background:#f8f9fa; color:#333; }
h1 { text-align:center; margin-bottom:20px; color:#222; }

/* Buttons */
button { padding:10px 15px; margin:5px; border:none; border-radius:5px; cursor:pointer; }
.btn-primary { background:#0070f3; color:white; }
.btn-success { background:#28a745; color:white; }
.btn-danger { background:#dc3545; color:white; }
button:disabled { background:#ccc; cursor:not-allowed; }

/* Select */
select { padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }

/* Modals */
.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:#fff; margin:15% auto; padding:20px; border-radius:10px; max-width:400px; text-align:center; position:relative; }
.close { position:absolute; top:10px; right:15px; font-size:28px; cursor:pointer; }
input[type=email], input[type=password], input[type=text] { width:90%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }

/* Progress */
#uploadProgress { margin-top:10px; display:none; color:#0070f3; }

/* Folder cards */
.folder-card {
  display:inline-block;
  width:120px;
  height:120px;
  margin:10px;
  background:#fff;
  border:1px solid #ddd;
  border-radius:10px;
  text-align:center;
  vertical-align:top;
  cursor:pointer;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
}
.folder-card:hover { transform:scale(1.05); }
.folder-card img { width:60px; height:60px; margin-top:10px; }
.folder-card span { display:block; margin-top:5px; font-size:0.9em; color:#0070f3; }

/* Folder modal */
.folder-modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); overflow:auto; }
.folder-modal-content { background:#fff; margin:50px auto; padding:20px; border-radius:10px; max-width:800px; }
.folder-modal-header { display:flex; justify-content:space-between; align-items:center; }
.folder-modal-header h2 { margin:0; }
.folder-modal-close { cursor:pointer; font-size:24px; }
.folder-files { display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; }
.file-item { width:100px; display:flex; flex-direction:column; align-items:center; }
.file-item img { width:80px; height:80px; object-fit:cover; border-radius:6px; }
.file-item span { font-size:0.75em; text-align:center; margin-top:5px; }
.file-item a { font-size:0.7em; margin-top:3px; text-decoration:none; color:#0070f3; }

/* Drag & Drop */
#dropArea { border:2px dashed #0070f3; padding:30px; text-align:center; border-radius:10px; margin-bottom:20px; background:#fff; cursor:pointer; }
#dropArea.dragover { background:#e0f0ff; }

/* File preview */
#filePreview div { margin-bottom:5px; }
#filePreview img { width:60px; height:60px; object-fit:cover; margin-right:5px; border-radius:5px; vertical-align:middle; }

/* Footer */
footer { text-align:center; color:#777; margin-top:40px; font-size:0.9em; }
</style>
</head>
<body>

<h1>Cloud Folder</h1>

<!-- Login -->
<div style="text-align:center; margin-bottom:20px;">
  <button class="btn btn-primary" id="userLoginBtn">Login to Upload</button>
  <button class="btn btn-danger" id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" id="loginClose">&times;</span>
    <h3>User Login</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button class="btn btn-success" id="loginSubmit">Login</button>
    <p id="loginError" style="color:red; display:none;">Invalid credentials!</p>
  </div>
</div>

<div id="dashboard" style="display:none;">
  <h2>Upload Files</h2>

  <!-- Folder Selection -->
  <div>
    <label>Select or Add Folder:</label>
    <select id="folderSelect">
      <option value="">-- Add New Folder --</option>
    </select>
    <input type="text" id="newFolderName" placeholder="New folder name" style="display:none; margin-top:5px;">
  </div>

  <!-- Drag & Drop -->
  <div id="dropArea">
    <p>Drag & drop files here or click to select</p>
    <input type="file" id="fileInput" multiple style="display:none">
  </div>
  <div id="filePreview"></div>

  <div id="uploadProgress"></div>
  <button id="cancelFiles" class="btn btn-danger">Cancel</button>
  <button id="uploadFiles" class="btn btn-success">Upload</button>
</div>

<!-- Search -->
<div style="text-align:center; margin-bottom:20px;">
  <input type="text" id="searchBox" placeholder="Search folders or files...">
</div>

<!-- Folders displayed as cards -->
<div id="softwareFolders"></div>

<!-- Folder modal -->
<div id="folderModal" class="folder-modal">
  <div class="folder-modal-content">
    <div class="folder-modal-header">
      <h2 id="modalFolderName">Folder</h2>
      <span class="folder-modal-close" id="folderModalClose">&times;</span>
    </div>
    <div class="folder-files" id="modalFolderFiles"></div>
  </div>
</div>

<footer>Â© 2025 Cloud Folder</footer>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const supabaseUrl = 'https://hqwbffwvxgzqjkrygryr.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhxd2JmZnd2eGd6cWprcnlncnlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MjMwMDEsImV4cCI6MjA3NTM5OTAwMX0.mQ9vxp76KYcP10kQBD33sXOy56apQJDolbyv0CMPN3c';
const supabase = createClient(supabaseUrl, supabaseKey);

const userLoginBtn = document.getElementById('userLoginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginModal = document.getElementById('loginModal');
const loginClose = document.getElementById('loginClose');
const loginSubmit = document.getElementById('loginSubmit');
const loginError = document.getElementById('loginError');
const dashboard = document.getElementById('dashboard');
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const folderSelect = document.getElementById('folderSelect');
const newFolderName = document.getElementById('newFolderName');
const filePreview = document.getElementById('filePreview');
const uploadFilesBtn = document.getElementById('uploadFiles');
const cancelFilesBtn = document.getElementById('cancelFiles');
const uploadProgress = document.getElementById('uploadProgress');
const softwareFolders = document.getElementById('softwareFolders');
const searchBox = document.getElementById('searchBox');

const folderModal = document.getElementById('folderModal');
const folderModalClose = document.getElementById('folderModalClose');
const modalFolderName = document.getElementById('modalFolderName');
const modalFolderFiles = document.getElementById('modalFolderFiles');

let selectedFiles = [];
let allItems = [];
const imageExtensions = ['.jpg','.jpeg','.png','.gif','.bmp','.webp','.svg'];

// Login
userLoginBtn.addEventListener('click', ()=>loginModal.style.display='block');
loginClose.addEventListener('click', ()=>loginModal.style.display='none');
window.addEventListener('click', e=>{if(e.target===loginModal) loginModal.style.display='none';});

loginSubmit.addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  try {
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;
    loginModal.style.display='none';
  } catch(err){
    loginError.style.display='block';
  }
});

logoutBtn.addEventListener('click', async ()=>{
  await supabase.auth.signOut();
});

// Auth state
supabase.auth.onAuthStateChange((event, session)=>{
  if(session){
    dashboard.style.display='block';
    userLoginBtn.style.display='none';
    logoutBtn.style.display='inline-block';
    loadFolderCards();
  } else {
    dashboard.style.display='none';
    userLoginBtn.style.display='inline-block';
    logoutBtn.style.display='none';
  }
});

// Folder select
folderSelect.addEventListener('change', e=>{
  if(e.target.value==='') newFolderName.style.display='block';
  else { newFolderName.style.display='none'; newFolderName.value=''; }
});

// Drag & drop
dropArea.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', e=>addFiles(e.target.files));
dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); });
dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); addFiles(e.dataTransfer.files); });

function addFiles(files){
  for(const file of files){
    if(selectedFiles.find(f=>f.name===file.name && f.size===file.size)) continue;
    selectedFiles.push(file);
  }
  renderPreview();
}

function renderPreview(){
  filePreview.innerHTML='';
  selectedFiles.forEach(file=>{
    const div = document.createElement('div');
    const ext = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
    if(imageExtensions.includes(ext)){
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      div.appendChild(img);
    }
    const text = document.createElement('span');
    text.textContent = file.name;
    div.appendChild(text);
    filePreview.appendChild(div);
  });
}

cancelFilesBtn.addEventListener('click', ()=>{
  selectedFiles=[];
  renderPreview();
  uploadProgress.style.display='none';
});

// Upload files
uploadFilesBtn.addEventListener('click', async ()=>{
  let folder = folderSelect.value || newFolderName.value.trim();
  if(!folder){ alert('Select or enter a folder'); return; }
  if(selectedFiles.length===0){ alert('No files selected'); return; }

  const safeFolder = folder.replace(/[^a-zA-Z0-9_-]/g,'_');
  uploadFilesBtn.disabled=true;
  uploadFilesBtn.textContent='Uploading...';
  uploadProgress.style.display='block';
  uploadProgress.textContent='';

  let successCount=0, errorCount=0;

  for(let i=0;i<selectedFiles.length;i++){
    const file = selectedFiles[i];
    uploadProgress.textContent=`Uploading ${i+1}/${selectedFiles.length}: ${file.name}`;

    try{
      const { error:uploadError } = await supabase.storage.from('cloud').upload(`${safeFolder}/${file.name}`, file, { upsert:true });
      if(uploadError) throw uploadError;

      const { data:{ publicUrl } } = supabase.storage.from('cloud').getPublicUrl(`${safeFolder}/${file.name}`);

      const { error:dbError } = await supabase.from('software').insert({
        title:file.name,
        folder:safeFolder,
        download_url:publicUrl,
        checksum:`Size: ${file.size} bytes`,
        image_url: publicUrl
      });
      if(dbError) throw dbError;
      successCount++;
    } catch(err){
      console.error(err);
      errorCount++;
    }
  }

  alert(`Upload done: ${successCount} success, ${errorCount} failed`);
  selectedFiles=[];
  renderPreview();
  folderSelect.value='';
  newFolderName.value='';
  newFolderName.style.display='none';
  uploadFilesBtn.disabled=false;
  uploadFilesBtn.textContent='Upload';
  uploadProgress.style.display='none';
  loadFolderCards();
});

// Load folders as cards
async function loadFolderCards(){
  const { data: items } = await supabase.from('software').select('*').order('uploaded_at',{ascending:false});
  allItems = items;
  const folders = {};
  items.forEach(item=>{ if(!folders[item.folder]) folders[item.folder]=[]; folders[item.folder].push(item); });

  folderSelect.innerHTML='<option value="">-- Add New Folder --</option>'+Object.keys(folders).map(f=>`<option value="${f}">${f}</option>`).join('');

  softwareFolders.innerHTML=Object.entries(folders).map(([name, files])=>`
    <div class="folder-card" onclick="openFolder('${name}')">
      <img src="https://cdn-icons-png.flaticon.com/512/715/715676.png">
      <span>${name} (${files.length})</span>
    </div>
  `).join('');
}

// Open folder modal
folderModalClose.addEventListener('click', ()=>folderModal.style.display='none');
window.openFolder=(folderName)=>{
  modalFolderName.textContent=folderName;
  const files = allItems.filter(f=>f.folder===folderName);
  modalFolderFiles.innerHTML=files.map(file=>{
    const ext = file.title.slice(file.title.lastIndexOf('.')).toLowerCase();
    const isImage = imageExtensions.includes(ext);
    return `
      <div class="file-item">
        <img src="${isImage?file.image_url:'https://via.placeholder.com/80?text=ð'}">
        <span>${file.title}</span>
        <a href="${file.download_url}" download>Download</a>
      </div>
    `;
  }).join('');
  folderModal.style.display='block';
}

// Search folders
searchBox.addEventListener('input', ()=>{
  const term = searchBox.value.toLowerCase();
  document.querySelectorAll('.folder-card').forEach(card=>{
    const text = card.querySelector('span').textContent.toLowerCase();
    card.style.display = text.includes(term)?'inline-block':'none';
  });
});
</script>
</body>
</html>
