<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Folder</title>
<link rel="icon" href="icon.png" type="image/png">
<style>
body { font-family: Arial,sans-serif; margin:0; padding:20px; background:#f8f9fa; color:#333; max-width:1200px; margin:auto;}
h1 { text-align:center; margin-bottom:20px; color:#222; }

/* Buttons */
button { padding:8px 12px; margin:5px; border:none; border-radius:5px; cursor:pointer; }
.btn-primary { background:#0070f3; color:white; }
.btn-success { background:#28a745; color:white; }
.btn-danger { background:#dc3545; color:white; }
button:disabled { background:#ccc; cursor:not-allowed; }

/* Inputs */
input[type=text], input[type=email], input[type=password], select { padding:10px; border-radius:5px; border:1px solid #ccc; width:calc(100% - 22px); margin:5px 0; }

/* Modals */
.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:#fff; margin:10% auto; padding:20px; border-radius:10px; max-width:400px; text-align:center; position:relative; }
.close { position:absolute; top:10px; right:15px; font-size:28px; cursor:pointer; }

/* Popup message (center top) */
#popupMessage { display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#0070f3; color:white; padding:12px 20px; border-radius:8px; z-index:20000; box-shadow:0 2px 5px rgba(0,0,0,0.3); font-weight:bold; }

/* Folder Cards (like Windows) */
.folder-container { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; }
.folder-card { width:120px; height:140px; background:#fff; border:1px solid #ddd; border-radius:10px; text-align:center; cursor:pointer; position:relative; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease;}
.folder-card:hover { transform:scale(1.05); }
.folder-card img { width:60px; height:60px; margin-top:10px; object-fit:cover; border-radius:5px; }
.folder-card span { display:block; margin-top:5px; font-size:0.9em; color:#0070f3; }
.delete-folder-btn { position:absolute; top:5px; right:5px; background:#dc3545; color:white; font-size:0.8em; padding:2px 5px; border-radius:4px; cursor:pointer; }

/* Folder Modal */
.folder-modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); overflow:auto; }
.folder-modal-content { background:#fff; margin:50px auto; padding:20px; border-radius:10px; max-width:900px; }
.folder-modal-header { display:flex; justify-content:space-between; align-items:center; }
.folder-modal-header h2 { margin:0; }
.folder-modal-close { cursor:pointer; font-size:24px; }
.folder-files { display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; }
.file-item { width:100px; display:flex; flex-direction:column; align-items:center; }
.file-item img { width:80px; height:80px; object-fit:cover; border-radius:6px; }
.file-item span { font-size:0.75em; text-align:center; margin-top:5px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:100%; }
.file-item input[type=checkbox] { margin-top:5px; }
.file-item a { font-size:0.7em; margin-top:3px; text-decoration:none; color:#0070f3; }

/* Drag & Drop */
#dropArea { border:2px dashed #0070f3; padding:30px; text-align:center; border-radius:10px; margin-bottom:20px; background:#fff; cursor:pointer; }
#dropArea.dragover { background:#e0f0ff; }

/* File preview */
#filePreview { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
#filePreview .preview-item { width:100px; text-align:center; }
#filePreview .preview-item img { width:80px; height:80px; object-fit:cover; border-radius:5px; }
.progress-bar { width:100%; background:#f0f0f0; border-radius:5px; margin-top:3px; height:6px; overflow:hidden; }
.progress-fill { width:0%; height:100%; background:#28a745; transition:width 0.2s; border-radius:5px; }

/* Footer */
footer { text-align:center; color:#777; margin-top:40px; font-size:0.9em; }
</style>
</head>
<body>

<h1>Cloud Folder</h1>

<div style="text-align:center; margin-bottom:20px;">
  <button class="btn btn-primary" id="userLoginBtn">Login to Upload</button>
  <button class="btn btn-danger" id="logoutBtn" style="display:none;">Logout</button>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" id="loginClose">&times;</span>
    <h3>User Login</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button class="btn btn-success" id="loginSubmit">Login</button>
    <p id="loginError" style="color:red; display:none;">Invalid credentials!</p>
  </div>
</div>

<!-- Popup -->
<div id="popupMessage"></div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h2>Upload Files</h2>
  <div>
    <label>Select or Add Folder:</label>
    <select id="folderSelect">
      <option value="">-- Add New Folder --</option>
    </select>
    <input type="text" id="newFolderName" placeholder="New folder name" style="display:block; margin-top:5px;">
  </div>
  <div id="dropArea">
    <p>Drag & drop files here or click to select</p>
    <input type="file" id="fileInput" multiple style="display:none">
  </div>
  <div id="filePreview"></div>
  <button id="cancelFiles" class="btn btn-danger">Cancel</button>
  <button id="uploadFiles" class="btn btn-success">Upload</button>
</div>

<div style="text-align:center; margin-bottom:20px;">
  <input type="text" id="searchBox" placeholder="Search folders or files...">
</div>

<div class="folder-container" id="softwareFolders"></div>

<!-- Folder modal -->
<div id="folderModal" class="folder-modal">
  <div class="folder-modal-content">
    <div class="folder-modal-header">
      <h2 id="modalFolderName">Folder</h2>
      <span class="folder-modal-close" id="folderModalClose">&times;</span>
    </div>
    <button class="btn btn-danger" id="deleteFilesBtn">Delete Selected Files</button>
    <div class="folder-files" id="modalFolderFiles"></div>
  </div>
</div>

<footer>Â© 2025 Cloud Folder</footer>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const supabaseUrl='https://hqwbffwvxgzqjkrygryr.supabase.co';
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhxd2JmZnd2eGd6cWprcnlncnlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MjMwMDEsImV4cCI6MjA3NTM5OTAwMX0.mQ9vxp76KYcP10kQBD33sXOy56apQJDolbyv0CMPN3c';
const supabase=createClient(supabaseUrl,supabaseKey);

// Elements
const userLoginBtn=document.getElementById('userLoginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const loginModal=document.getElementById('loginModal');
const loginClose=document.getElementById('loginClose');
const loginSubmit=document.getElementById('loginSubmit');
const loginError=document.getElementById('loginError');
const dashboard=document.getElementById('dashboard');
const dropArea=document.getElementById('dropArea');
const fileInput=document.getElementById('fileInput');
const folderSelect=document.getElementById('folderSelect');
const newFolderName=document.getElementById('newFolderName');
const filePreview=document.getElementById('filePreview');
const uploadFilesBtn=document.getElementById('uploadFiles');
const cancelFilesBtn=document.getElementById('cancelFiles');
const softwareFolders=document.getElementById('softwareFolders');
const searchBox=document.getElementById('searchBox');
const folderModal=document.getElementById('folderModal');
const folderModalClose=document.getElementById('folderModalClose');
const modalFolderName=document.getElementById('modalFolderName');
const modalFolderFiles=document.getElementById('modalFolderFiles');
const deleteFilesBtn=document.getElementById('deleteFilesBtn');
const popupMessage=document.getElementById('popupMessage');

let selectedFiles=[];
let allItems=[];
let currentFolder='';
const imageExtensions=['.jpg','.jpeg','.png','.gif','.bmp','.webp','.svg'];

// ---------------- POPUP ----------------
function showPopup(msg,color='#0070f3'){
  popupMessage.textContent=msg;
  popupMessage.style.background=color;
  popupMessage.style.display='block';
  setTimeout(()=>{ popupMessage.style.display='none'; },2000);
}

// ---------------- LOGIN ----------------
userLoginBtn.addEventListener('click',()=>loginModal.style.display='block');
loginClose.addEventListener('click',()=>loginModal.style.display='none');
window.addEventListener('click',e=>{if(e.target===loginModal) loginModal.style.display='none';});

loginSubmit.addEventListener('click',async()=>{
  const email=document.getElementById('loginEmail').value;
  const password=document.getElementById('loginPassword').value;
  try{
    const {error}=await supabase.auth.signInWithPassword({email,password});
    if(error) throw error;
  }catch(err){ loginError.style.display='block'; return; }
});

// Force logout and prevent auto-login
logoutBtn.addEventListener('click',async()=>{
  await supabase.auth.signOut();
  localStorage.removeItem('supabase.auth.token'); // prevent auto-login
  dashboard.style.display='none';
  userLoginBtn.style.display='inline-block';
  logoutBtn.style.display='none';
  showPopup('Logged out','#0070f3');
});

// Auth state listener
supabase.auth.onAuthStateChange((event,session)=>{
  if(session){
    dashboard.style.display='block';
    userLoginBtn.style.display='none';
    logoutBtn.style.display='inline-block';
    loginModal.style.display='none';
    showPopup('Login successful','#28a745');
  }else{
    dashboard.style.display='none';
    userLoginBtn.style.display='inline-block';
    logoutBtn.style.display='none';
  }
});

// ---------------- FOLDER & FILE UPLOAD ----------------
folderSelect.addEventListener('change',e=>{
  if(e.target.value===''){ newFolderName.style.display='block'; } else { newFolderName.style.display='none'; }
});

dropArea.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',e=>{ addFiles(e.target.files); });
dropArea.addEventListener('dragover',e=>{ e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave',e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); });
dropArea.addEventListener('drop',e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); addFiles(e.dataTransfer.files); });

function addFiles(files){
  for(const file of files){ if(!selectedFiles.find(f=>f.name===file.name && f.size===file.size)) selectedFiles.push(file); }
  renderFilePreview();
}

function renderFilePreview(){
  filePreview.innerHTML='';
  selectedFiles.forEach(file=>{
    const div=document.createElement('div'); div.className='preview-item';
    const ext=file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
    if(imageExtensions.includes(ext)){ const img=document.createElement('img'); img.src=URL.createObjectURL(file); div.appendChild(img); }
    const span=document.createElement('span'); span.textContent=file.name; div.appendChild(span);
    const progress=document.createElement('div'); progress.className='progress-bar'; const fill=document.createElement('div'); fill.className='progress-fill'; progress.appendChild(fill); div.appendChild(progress);
    file.progressElement=fill;
    filePreview.appendChild(div);
  });
}

cancelFilesBtn.addEventListener('click',()=>{
  selectedFiles=[]; renderFilePreview();
});

// ---------------- UPLOAD ----------------
uploadFilesBtn.addEventListener('click',async()=>{
  let folder=folderSelect.value; if(!folder){ folder=newFolderName.value.trim(); if(!folder){ showPopup('Enter folder name','#dc3545'); return; } }
  if(selectedFiles.length===0){ showPopup('No files selected','#dc3545'); return; }
  const safeFolder=folder.replace(/[^a-zA-Z0-9_-]/g,'_');
  uploadFilesBtn.disabled=true; uploadFilesBtn.textContent='Uploading...';
  for(let i=0;i<selectedFiles.length;i++){
    const file=selectedFiles[i];
    try{
      const {error}=await supabase.storage.from('cloud').upload(`${safeFolder}/${file.name}`,file,{upsert:true});
      if(error) throw error;
      let prog=0; const interval=setInterval(()=>{ prog+=10; file.progressElement.style.width=prog+'%'; if(prog>=100) clearInterval(interval); },50);
      const { data:{ publicUrl } }=supabase.storage.from('cloud').getPublicUrl(`${safeFolder}/${file.name}`);
      await supabase.from('software').insert({title:file.name,folder:safeFolder,download_url:publicUrl,checksum:`Size: ${file.size} bytes`,image_url:publicUrl});
    }catch(e){ console.error(e); }
  }
  showPopup('Upload complete','#28a745');
  selectedFiles=[]; renderFilePreview(); newFolderName.value=''; folderSelect.value=''; uploadFilesBtn.disabled=false; uploadFilesBtn.textContent='Upload';
  loadFolderCards();
});

// ---------------- LOAD FOLDERS ----------------
async function loadFolderCards(){
  try{
    const { data: items, error }=await supabase.from('software').select('*').order('uploaded_at',{ascending:false});
    if(error) throw error;
    allItems=items;
    const folders=[...new Set(items.map(i=>i.folder))].sort();
    folderSelect.innerHTML='<option value="">-- Add New Folder --</option>'+folders.map(f=>`<option value="${f}">${f}</option>`).join('');
    softwareFolders.innerHTML=folders.map(f=>{
      const files=items.filter(i=>i.folder===f);
      const firstImg=files.find(fi=>imageExtensions.includes(fi.title.slice(fi.title.lastIndexOf('.')).toLowerCase()));
      const thumb=firstImg ? firstImg.image_url : 'https://via.placeholder.com/60?text=ð';
      return `<div class="folder-card">
        <img src="${thumb}" alt="${f}">
        <span>${f} (${files.length})</span>
        <button class="delete-folder-btn">Delete</button>
      </div>`;
    }).join('') || '<p>No folders yet.</p>';

    // Add click events
    document.querySelectorAll('.folder-card').forEach(card=>{
      const name=card.querySelector('span').textContent.split(' (')[0];
      card.querySelector('img').parentElement.addEventListener('click',()=>openFolderModal(name));
      card.querySelector('.delete-folder-btn').addEventListener('click',e=>{
        e.stopPropagation(); deleteFolder(name);
      });
    });

  }catch(e){ console.error(e); }
}

// ---------------- OPEN FOLDER MODAL ----------------
function openFolderModal(f){
  currentFolder=f; modalFolderName.textContent=f;
  const files=allItems.filter(i=>i.folder===f);
  modalFolderFiles.innerHTML='';
  files.forEach(file=>{
    const div=document.createElement('div'); div.className='file-item';
    const ext=file.title.slice(file.title.lastIndexOf('.')).toLowerCase();
    const img=document.createElement('img'); img.src=imageExtensions.includes(ext)?file.image_url:'https://via.placeholder.com/80?text=ð';
    div.appendChild(img);
    const span=document.createElement('span'); span.textContent=file.title; div.appendChild(span);
    const chk=document.createElement('input'); chk.type='checkbox'; chk.dataset.id=file.id; div.appendChild(chk);
    const a=document.createElement('a'); a.href=file.download_url; a.download=''; a.textContent='Download'; div.appendChild(a);
    modalFolderFiles.appendChild(div);
  });
  folderModal.style.display='block';
}
folderModalClose.addEventListener('click',()=>folderModal.style.display='none');

// ---------------- DELETE FILES ----------------
deleteFilesBtn.addEventListener('click',async()=>{
  const checked=[...modalFolderFiles.querySelectorAll('input[type=checkbox]:checked')];
  if(checked.length===0){ showPopup('No files selected','#dc3545'); return; }
  if(!confirm('Delete selected files?')) return;
  for(const cb of checked){
    const id=cb.dataset.id;
    const item=allItems.find(f=>f.id===id);
    if(item){ await supabase.storage.from('cloud').remove([`${item.folder}/${item.title}`]); await supabase.from('software').delete().eq('id',id);}
  }
  showPopup('Selected files deleted','#28a745'); folderModal.style.display='none'; loadFolderCards();
});

// ---------------- DELETE FOLDER ----------------
async function deleteFolder(f){
  if(!confirm('Delete folder and all files?')) return;
  const files=allItems.filter(i=>i.folder===f);
  for(const file of files){
    await supabase.storage.from('cloud').remove([`${file.folder}/${file.title}`]);
    await supabase.from('software').delete().eq('id',file.id);
  }
  showPopup('Folder deleted','#28a745'); loadFolderCards();
}

// ---------------- SEARCH ----------------
searchBox.addEventListener('input',()=>{
  const term=searchBox.value.toLowerCase();
  document.querySelectorAll('.folder-card').forEach(card=>{
    const text=card.querySelector('span').textContent.toLowerCase();
    const folderName=text.split(' (')[0];
    const files=allItems.filter(f=>f.folder===folderName).map(f=>f.title.toLowerCase());
    const matches=folderName.includes(term) || files.some(fn=>fn.includes(term));
    card.style.display=matches?'inline-block':'none';
  });
});

// ---------------- INITIAL ----------------
loadFolderCards();

</script>
</body>
</html>
