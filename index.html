<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Software Downloads</title>
<link rel="icon" href="icon.png" type="image/png">
<style>
body { font-family: Arial,sans-serif; margin:0; padding:20px; max-width:1000px; margin:auto; background:#f8f9fa; color:#333; }
h1 { text-align:center; margin-bottom:20px; color:#222; }

/* Buttons */
button { padding:10px 15px; margin:5px; border:none; border-radius:5px; cursor:pointer; }
.btn-primary { background:#0070f3; color:white; }
.btn-success { background:#28a745; color:white; }
.btn-danger { background:#dc3545; color:white; }
button:disabled { background:#ccc; cursor:not-allowed; }

/* Admin Modal */
.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:#fff; margin:15% auto; padding:20px; border-radius:10px; max-width:400px; text-align:center; position:relative; }
.close { position:absolute; top:10px; right:15px; font-size:28px; cursor:pointer; }
input[type=email], input[type=password], input[type=text] { width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }

/* Dashboard */
#dashboard { display:none; margin-top:20px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
#dashboard h2 { text-align:center; }
.form-group { margin-bottom:15px; }
.form-group label { display:block; margin-bottom:5px; }
.software-list-admin { margin-top:20px; }
.software-admin-item { border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px; display:flex; align-items:center; justify-content:space-between; }

/* Drag & Drop */
#dropArea { border:2px dashed #0070f3; padding:30px; text-align:center; border-radius:10px; margin-bottom:20px; background:#fff; cursor:pointer; }
#dropArea.dragover { background:#e0f0ff; }

/* File Preview */
#filePreview div { margin-bottom:5px; }

/* Progress */
#uploadProgress { margin-top:10px; display:none; color:#0070f3; }

/* Public software cards */
.wrap { display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:20px; padding:10px; }
.software { background:#fff; padding:20px; border:1px solid #ddd; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); text-align:center; transition: transform 0.2s ease, box-shadow 0.2s ease; }
.software:hover { transform:translateY(-5px); box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.software img { width:64px; height:64px; object-fit:contain; margin-bottom:10px; }
.software h2 { margin:0 0 10px 0; font-size:1.1em; color:#0070f3; }
.download-btn { display:inline-block; margin-top:10px; padding:10px 18px; background:#0070f3; color:white; text-decoration:none; border-radius:6px; transition: background 0.2s ease; }
.download-btn:hover { background:#0056c7; }
.checksum { font-size:0.9em; color:#555; margin-top:8px; word-break:break-all; }

footer { text-align:center; color:#777; margin-top:40px; font-size:0.9em; }
</style>
</head>
<body>

<h1>Download Center</h1>

<!-- Admin Login Button -->
<div style="text-align:center; margin-bottom:20px;">
  <button class="btn btn-primary" id="adminLoginBtn">Admin Login</button>
  <button class="btn btn-danger" id="logoutBtn" style="display:none;">Logout</button>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" id="loginClose">&times;</span>
    <h3>Admin Login</h3>
    <input type="email" id="loginEmail" placeholder="Email (e.g., admin@example.com)">
    <input type="password" id="loginPassword" placeholder="Password">
    <button class="btn btn-success" id="loginSubmit">Login</button>
    <p id="loginError" style="color:red; display:none;">Invalid credentials!</p>
  </div>
</div>

<!-- Admin Dashboard -->
<div id="dashboard">
  <h2>Admin Dashboard</h2>

  <!-- Folder Name Input -->
  <div class="form-group">
    <label for="folderName">Folder Name:</label>
    <input type="text" id="folderName" placeholder="Enter folder name">
  </div>

  <!-- Drag & Drop + File Preview -->
  <div id="dropArea">
    <p>Drag & drop files here or click to select</p>
    <input type="file" id="fileInput" multiple style="display:none">
  </div>
  <div id="filePreview"></div>

  <!-- Progress -->
  <div id="uploadProgress"></div>

  <!-- Buttons -->
  <div style="margin-top:10px;">
    <button id="cancelFiles" class="btn btn-danger">Cancel</button>
    <button id="uploadFiles" class="btn btn-success">Create</button>
  </div>

  <div class="software-list-admin" id="adminSoftwareList"></div>
</div>

<!-- Search -->
<div class="search-container" style="text-align:center; margin-bottom:20px;">
  <input type="text" id="searchBox" placeholder="Search software...">
</div>

<!-- Software List -->
<div class="wrap" id="softwareList"></div>

<footer>Â© 2025 My Software Downloads</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCX4kIednVMV7Lo1BNT7ht6TUsqAiofBC0",
  authDomain: "cloud-afe3c.firebaseapp.com",
  projectId: "cloud-afe3c",
  storageBucket: "cloud-afe3c.firebasestorage.app",
  messagingSenderId: "149642193133",
  appId: "1:149642193133:web:cd4f22112f754bb1fdc4e4",
  measurementId: "G-M9W6KYKEY9"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// Elements
const adminLoginBtn = document.getElementById('adminLoginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginModal = document.getElementById('loginModal');
const loginClose = document.getElementById('loginClose');
const loginSubmit = document.getElementById('loginSubmit');
const loginError = document.getElementById('loginError');
const dashboard = document.getElementById('dashboard');
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const folderInput = document.getElementById('folderName');
const adminSoftwareList = document.getElementById('adminSoftwareList');
const softwareList = document.getElementById('softwareList');
const searchBox = document.getElementById('searchBox');
const filePreview = document.getElementById('filePreview');
const cancelFiles = document.getElementById('cancelFiles');
const uploadFiles = document.getElementById('uploadFiles');
const uploadProgress = document.getElementById('uploadProgress');

let selectedFiles = [];

// Admin login modal
adminLoginBtn.addEventListener('click', ()=>loginModal.style.display='block');
loginClose.addEventListener('click', ()=>loginModal.style.display='none');
window.addEventListener('click', e=>{ if(e.target===loginModal) loginModal.style.display='none'; });
loginSubmit.addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
    loginError.style.display='none';
    loginModal.style.display='none';
  }catch(err){
    console.error('Login error:', err);
    loginError.style.display='block';
  }
});
logoutBtn.addEventListener('click', async ()=>{
  try {
    await signOut(auth);
  } catch (err) {
    console.error('Logout error:', err);
  }
});

onAuthStateChanged(auth,user=>{
  if(user){
    dashboard.style.display='block';
    adminLoginBtn.style.display='none';
    logoutBtn.style.display='inline-block';
    loadSoftware();
  } else {
    dashboard.style.display='none';
    adminLoginBtn.style.display='inline-block';
    logoutBtn.style.display='none';
  }
});

// Drag & Drop
dropArea.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', (e)=>addFiles(e.target.files));
dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); });
dropArea.addEventListener('drop', e=>{
  e.preventDefault();
  dropArea.classList.remove('dragover');
  addFiles(e.dataTransfer.files);
});

function addFiles(files){
  for(const file of files){
    if (selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
      console.warn('Duplicate file skipped:', file.name);
      continue;
    }
    selectedFiles.push(file);
  }
  renderPreview();
}

function renderPreview(){
  filePreview.innerHTML='';
  selectedFiles.forEach(file=>{
    const div = document.createElement('div');
    div.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    filePreview.appendChild(div);
  });
}

cancelFiles.addEventListener('click', ()=>{
  selectedFiles = [];
  renderPreview();
  uploadProgress.style.display = 'none';
});

uploadFiles.addEventListener('click', async ()=>{
  const folder = folderInput.value.trim();
  if(!folder){ alert('Enter folder name'); return; }
  if(selectedFiles.length===0){ alert('No files selected'); return; }

  // Sanitize folder name
  const safeFolder = folder.replace(/[^a-zA-Z0-9_-]/g, '_');

  uploadFiles.disabled = true;
  uploadFiles.textContent = 'Uploading...';
  uploadProgress.style.display = 'block';
  uploadProgress.textContent = '';

  let successCount = 0;
  let errorCount = 0;

  try {
    for(let i = 0; i < selectedFiles.length; i++){
      const file = selectedFiles[i];
      uploadProgress.textContent = `Uploading ${i+1} of ${selectedFiles.length}: ${file.name}...`;

      console.log(`Uploading: ${file.name} to folder: ${safeFolder}`);

      // Simple checksum placeholder
      const checksum = `Size: ${file.size} bytes (SHA-256 pending)`;
      const storageRef = ref(storage, `software/${safeFolder}/${file.name}`);
      
      try {
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        await addDoc(collection(db, 'software'), {
          title: file.name,
          folder: safeFolder,
          downloadUrl: url,
          checksum: checksum,
          imageUrl: 'https://via.placeholder.com/64',
          uploadedAt: new Date().toISOString()
        });
        successCount++;
        console.log(`Success: ${file.name} uploaded`);
      } catch (fileErr) {
        console.error(`Error uploading ${file.name}:`, fileErr);
        errorCount++;
      }
    }

    if (errorCount > 0) {
      alert(`Upload partial: ${successCount} succeeded, ${errorCount} failed. Check console for details.`);
    } else {
      alert(`Upload complete! ${successCount} files added.`);
    }

    selectedFiles = [];
    renderPreview();
    folderInput.value = '';
    loadSoftware();
  } catch (err) {
    console.error('Overall upload error:', err);
    alert(`Upload failed: ${err.message}. Check Firebase setup and console.`);
  } finally {
    uploadFiles.disabled = false;
    uploadFiles.textContent = 'Create';
    uploadProgress.style.display = 'none';
  }
});

// Load software (public + admin list) - Optimized HTML building
async function loadSoftware(){
  try {
    const snapshot = await getDocs(collection(db, 'software'));
    const publicCards = [];
    const adminItems = [];
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const id = docSnap.id;
      // Public view
      publicCards.push(`
        <div class="software">
          <img src="${data.imageUrl || 'https://via.placeholder.com/64'}" alt="${data.title}">
          <h2>[${data.folder}] ${data.title}</h2>
          <a class="download-btn" href="${data.downloadUrl}" download>Download</a>
          <p class="checksum">${data.checksum}</p>
        </div>
      `);
      // Admin list
      adminItems.push(`
        <div class="software-admin-item">
          <strong>[${data.folder}] ${data.title}</strong>
          <button class="btn btn-danger" onclick="deleteSoftware('${id}')">Delete</button>
        </div>
      `);
    });
    softwareList.innerHTML = publicCards.join('');
    adminSoftwareList.innerHTML = adminItems.join('');
  } catch (err) {
    console.error('Load software error:', err);
    alert('Failed to load software list. Check Firebase rules.');
  }
}

// Delete software
window.deleteSoftware = async (id)=>{
  if (!confirm('Delete this software?')) return;
  const docRef = doc(db, 'software', id);
  try {
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      const fileRef = ref(storage, `software/${data.folder}/${data.title}`);
      await deleteObject(fileRef);
      await deleteDoc(docRef);
      loadSoftware();
      alert('Deleted successfully!');
    } else {
      alert('Document not found.');
    }
  } catch (error) {
    console.error('Delete error:', error);
    alert('Error deleting: ' + error.message);
  }
};

// Search
searchBox.addEventListener('input', ()=>{
  const term = searchBox.value.toLowerCase();
  Array.from(softwareList.getElementsByClassName('software')).forEach(card=>{
    const title = card.querySelector('h2')?.textContent.toLowerCase() || '';
    card.style.display = title.includes(term)?'block':'none';
  });
});

// Initial load
loadSoftware();
</script>
</body>
</html>
