<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Software Downloads</title>
<link rel="icon" href="icon.png" type="image/png">
<style>
body { font-family: Arial,sans-serif; margin:0; padding:20px; max-width:1000px; margin:auto; background:#f8f9fa; color:#333; }
h1,h2 { text-align:center; margin-bottom:20px; }
button { padding:6px 12px; margin:3px; border:none; border-radius:5px; cursor:pointer; }
.btn-primary { background:#0070f3; color:white; }
.btn-success { background:#28a745; color:white; }
.btn-danger { background:#dc3545; color:white; }
.modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:#fff; margin:15% auto; padding:20px; border-radius:10px; max-width:400px; text-align:center; position:relative; }
.close { position:absolute; top:10px; right:15px; font-size:28px; cursor:pointer; }
input[type=email], input[type=password], input[type=text], input[type=file] { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
#dashboard { display:none; margin-top:20px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
.folder-box { border:1px solid #0070f3; padding:10px; margin-bottom:10px; border-radius:5px; background:#f0f8ff; }
.folder-title { cursor:pointer; font-weight:bold; margin-bottom:5px; }
.folder-contents { margin-left:15px; display:none; }
.file-item { margin:2px 0; }
#dropArea { border:2px dashed #0070f3; padding:30px; text-align:center; border-radius:10px; margin-bottom:10px; background:#fff; cursor:pointer; }
#dropArea.dragover { background:#e0f0ff; }
</style>
</head>
<body>

<h1>Download Center</h1>

<div style="text-align:center; margin-bottom:20px;">
  <button class="btn btn-primary" id="adminLoginBtn">Admin Login</button>
  <button class="btn btn-danger" id="logoutBtn" style="display:none;">Logout</button>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" id="loginClose">&times;</span>
    <h3>Admin Login</h3>
    <input type="email" id="loginEmail" placeholder="Email (e.g., admin@example.com)">
    <input type="password" id="loginPassword" placeholder="Password">
    <button class="btn btn-success" id="loginSubmit">Login</button>
    <p id="loginError" style="color:red; display:none;">Invalid credentials!</p>
  </div>
</div>

<!-- Admin Dashboard -->
<div id="dashboard">
  <h2>Admin Dashboard</h2>
  <div class="form-group">
    <label>Folder Name:</label>
    <input type="text" id="folderName" placeholder="Enter folder name">
    <button class="btn btn-success" id="addFolderBtn">Add Folder</button>
  </div>

  <div id="dropArea">
    <p>Drag & drop files here or click to select</p>
    <input type="file" id="fileInput" multiple style="display:none">
  </div>

  <div id="filePreview"></div>
  <div id="folderList"></div>
</div>

<h2>All Folders</h2>
<div id="publicFolderList"></div>

<footer>Â© 2025 My Software Downloads</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCX4kIednVMV7Lo1BNT7ht6TUsqAiofBC0",
  authDomain: "cloud-afe3c.firebaseapp.com",
  projectId: "cloud-afe3c",
  storageBucket: "cloud-afe3c.firebasestorage.app",
  messagingSenderId: "149642193133",
  appId: "1:149642193133:web:cd4f22112f754bb1fdc4e4",
  measurementId: "G-M9W6KYKEY9"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const adminLoginBtn = document.getElementById('adminLoginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginModal = document.getElementById('loginModal');
const loginClose = document.getElementById('loginClose');
const loginSubmit = document.getElementById('loginSubmit');
const loginError = document.getElementById('loginError');
const dashboard = document.getElementById('dashboard');
const folderInput = document.getElementById('folderName');
const addFolderBtn = document.getElementById('addFolderBtn');
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const folderList = document.getElementById('folderList');
const publicFolderList = document.getElementById('publicFolderList');

let selectedFiles = [];
let foldersPending = [];

// Admin login modal
adminLoginBtn.addEventListener('click', ()=>loginModal.style.display='block');
loginClose.addEventListener('click', ()=>loginModal.style.display='none');
window.addEventListener('click', e=>{ if(e.target===loginModal) loginModal.style.display='none'; });

loginSubmit.addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
    loginError.style.display='none';
    loginModal.style.display='none';
  }catch(err){
    loginError.style.display='block';
  }
});

logoutBtn.addEventListener('click', ()=>signOut(auth));

onAuthStateChanged(auth,user=>{
  if(user){
    dashboard.style.display='block';
    adminLoginBtn.style.display='none';
    logoutBtn.style.display='inline-block';
    loadPublicFolders();
  } else {
    dashboard.style.display='none';
    adminLoginBtn.style.display='inline-block';
    logoutBtn.style.display='none';
  }
});

// Drag & Drop
dropArea.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', ()=>addFiles(fileInput.files));
dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); });
dropArea.addEventListener('drop', e=>{
  e.preventDefault();
  dropArea.classList.remove('dragover');
  addFiles(e.dataTransfer.files);
});

function addFiles(files){
  for(const file of files) selectedFiles.push(file);
  renderPreview();
}

function renderPreview(){
  filePreview.innerHTML='';
  selectedFiles.forEach(file=>{
    const div = document.createElement('div');
    div.textContent = file.name;
    filePreview.appendChild(div);
  });
}

// Add folder pending
addFolderBtn.addEventListener('click', ()=>{
  const folderName = folderInput.value.trim();
  if(!folderName) { alert('Enter folder name'); return; }
  if(foldersPending.find(f=>f.name===folderName)) { alert('Folder already exists'); return; }
  foldersPending.push({ name:folderName, files:[...selectedFiles] });
  selectedFiles=[];
  renderPreview();
  folderInput.value='';
  renderFoldersPending();
});

function renderFoldersPending(){
  folderList.innerHTML='';
  foldersPending.forEach((folder,index)=>{
    const div = document.createElement('div');
    div.classList.add('folder-box');
    div.innerHTML=`
      <div><strong>Folder: ${folder.name}</strong></div>
      <div id="folderFiles${index}"></div>
      <button class="btn btn-danger" id="cancelFolder${index}">Cancel</button>
      <button class="btn btn-success" id="createFolder${index}">Create</button>
    `;
    folderList.appendChild(div);
    const filesDiv = document.getElementById(`folderFiles${index}`);
    folder.files.forEach(f=>{
      const fDiv = document.createElement('div');
      fDiv.textContent=f.name;
      filesDiv.appendChild(fDiv);
    });

    document.getElementById(`cancelFolder${index}`).addEventListener('click', ()=>{
      foldersPending.splice(index,1);
      renderFoldersPending();
    });

    document.getElementById(`createFolder${index}`).addEventListener('click', async ()=>{
      if(folder.files.length===0){ alert('No files'); return; }
      for(const file of folder.files){
        const storageRef = ref(storage, `folders/${folder.name}/${file.name}`);
        await uploadBytes(storageRef,file);
        const url = await getDownloadURL(storageRef);
        await addDoc(collection(db,'software'),{
          title:file.name,
          folder:folder.name,
          downloadUrl:url
        });
      }
      foldersPending.splice(index,1);
      renderFoldersPending();
      loadPublicFolders();
    });
  });
}

// Load public folders
async function loadPublicFolders(){
  publicFolderList.innerHTML='';
  const qSnapshot = await getDocs(collection(db,'software'));
  const folders = {};
  qSnapshot.forEach(doc=>{ 
    const data=doc.data();
    if(!folders[data.folder]) folders[data.folder]=[];
    folders[data.folder].push({title:data.title,url:data.downloadUrl});
  });
  Object.keys(folders).forEach(folderName=>{
    const div = document.createElement('div');
    div.classList.add('folder-box');
    div.innerHTML = `<div class="folder-title">${folderName}</div><div class="folder-contents"></div>`;
    publicFolderList.appendChild(div);
    const contentsDiv = div.querySelector('.folder-contents');
    folders[folderName].forEach(file=>{
      const fDiv = document.createElement('div');
      fDiv.classList.add('file-item');
      fDiv.innerHTML=`<a href="${file.url}" target="_blank">${file.title}</a>`;
      contentsDiv.appendChild(fDiv);
    });
    div.querySelector('.folder-title').addEventListener('click', ()=>{
      contentsDiv.style.display = contentsDiv.style.display==='none'?'block':'none';
    });
  });
}
</script>

</body>
</html>
